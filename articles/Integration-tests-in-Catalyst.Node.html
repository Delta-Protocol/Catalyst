<!DOCTYPE html>
<!--[if IE]><![endif]-->
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <title>Using the file system | Catalyst Framework Documentation </title>
    <meta name="viewport" content="width=device-width">
    <meta name="title" content="Using the file system | Catalyst Framework Documentation ">
    <meta name="generator" content="docfx 2.46.0.0">
    
    <link rel="shortcut icon" href="../favicon.ico">
    <link rel="stylesheet" href="../styles/docfx.vendor.css">
    <link rel="stylesheet" href="../styles/docfx.css">
    <link rel="stylesheet" href="../styles/main.css">
    <link href="https://fonts.googleapis.com/css?family=Roboto" rel="stylesheet"> 
    <meta property="docfx:navrel" content="../toc.html">
    <meta property="docfx:tocrel" content="toc.html">
    
    <meta property="docfx:rel" content="../">
    
  </head>  <body data-spy="scroll" data-target="#affix" data-offset="120">
    <div id="wrapper">
      <header>
        
        <nav id="autocollapse" class="navbar navbar-inverse ng-scope" role="navigation">
          <div class="container">
            <div class="navbar-header">
              <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#navbar">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
              </button>
              
              <a class="navbar-brand" href="../index.html">
                <img id="logo" class="svg" src="../images/logo.svg" alt="">
              </a>
            </div>
            <div class="collapse navbar-collapse" id="navbar">
              <form class="navbar-form navbar-right" role="search" id="search">
                <div class="form-group">
                  <input type="text" class="form-control" id="search-query" placeholder="Search" autocomplete="off">
                </div>
              </form>
            </div>
          </div>
        </nav>
        
        <div class="subnav navbar navbar-default">
          <div class="container hide-when-search" id="breadcrumb">
            <ul class="breadcrumb">
              <li></li>
            </ul>
          </div>
        </div>
      </header>
      <div class="container body-content">
        
        <div id="search-results">
          <div class="search-list"></div>
          <div class="sr-items">
            <p><i class="glyphicon glyphicon-refresh index-loading"></i></p>
          </div>
          <ul id="pagination"></ul>
        </div>
      </div>
      <div role="main" class="container body-content hide-when-search">
        
        <div class="sidenav hide-when-search">
          <a class="btn toc-toggle collapse" data-toggle="collapse" href="#sidetoggle" aria-expanded="false" aria-controls="sidetoggle">Show / Hide Table of Contents</a>
          <div class="sidetoggle collapse" id="sidetoggle">
            <div id="sidetoc"></div>
          </div>
        </div>
        <div class="article row grid-right">
          <div class="col-md-10">
            <article class="content wrap" id="_content" data-uid="">

<blockquote><p>As explained in <a href="autofac.md">How is Autofac used in Catalyst.Node</a>, the Catalyst node is using a set of configuration files to choose and configure its dependencies. When writing integration tests involving several layers of dependencies, it would be cumbersome to have to reconfigure a large part of the container for each new test.<br>This article will try to explain a couple of tips that should help to reduce the pain that comes with writing such tests.</p>
</blockquote>
<h2 id="using-the-file-system">Using the file system</h2>
<p>For integration tests to be able to run independently of each other whilst using the file system, they need to inherit from <code>Catalyst.Node.Common.UnitTests.TestUtils.FileSystemBaseTest</code>. This class creates a unique folder for each test run and might clean older folders upon getting disposed.<br>As an example, this screenshot shows that a few folders have been created in the output folder of our test project. </p>
<ul>
<li>The <em>Config</em> folder contains configurations similar to the ones used by the node when running normally, which can be referenced to configure the container used in a given integration test.</li>
<li>Other folders such as <em>Mempool_with_InMemoryRepo</em>... are created as the tests run. Each test run will result in a different timestamp suffix (this is to allow running the same test with different parameters, or the same <code>Theory</code> with different <code>DataAttribute</code> in Xunit terminology, in separate folder whilst keeping the ability to automatically clean old folders).</li>
</ul>
<p><img src="../images/filesystem-int-tests.png" alt="Filesystem Int Tests"></p>
<p>From here, we can now use the folders to set up configuration scenarios needed by the test, or to output logs and other diagnostics from the tests.</p>
<h2 id="an-example-from-the-code">An example from the code</h2>
<p>Following is an integration test inheriting from <code>ConfigFileBasedTest</code>, which is the base class that can be used to write similar tests.</p>
<pre><code class="lang-csharp">public sealed class MessageCorrelationCacheIntegrationTests : ConfigFileBasedTest
{
    private readonly ILifetimeScope _scope;

    public MessageCorrelationCacheIntegrationTests(ITestOutputHelper output) : base(output)
    {
        var config = new ConfigurationBuilder()
            .AddJsonFile(Path.Combine(Constants.ConfigSubFolder, Constants.ComponentsJsonConfigFile))
            .Build();

        ConfigureContainerBuilder(config, 
            writeLogsToTestOutput: true, 
            writeLogsToFile: true);

        var container = ContainerBuilder.Build();
        _scope = container.BeginLifetimeScope(CurrentTestName);
    }

    [Fact]
    [Trait(Traits.TestType, Traits.IntegrationTest)]
    public async Task RequestStore_should_not_keep_records_for_longer_than_ttl()
    {
        ...
    }
</code></pre><p>In the constructor of the test, </p>
<ol>
<li>We pass on the <code>ITestOutputHelper</code> to the parent class</li>
<li>Then we proceed with registering the only JSON configuration file needed by the test </li>
<li>After that, we can call the ConfigureContainerBuilder on the parent class and mention which logging outputs we need. This method is virtual and can be overridden to add in extra registrations if needed.<br><em>NB: Please don&#39;t check in code with logging output turned on, this is simply offered to help understand issues when writing tests</em>.</li>
<li>Finally, we build the container and instantiate a named scope for the test in which we will need dependency injection.</li>
</ol>
<h2 id="notes">Notes</h2>
<ul>
<li><p>When trying to access the folder for your test on the file system, it is best to use the <code>protected readonly IFileSystem FileSystem</code> from <code>FileSystemBasedTest</code> and call the <code>GetCatalystHomeDir()</code> method. The method should return you the unique folder for this test run.</p>
</li>
<li><p>You shouldn&#39;t need to worry about cleaning the test folders after each run: the <code>FileSystemBasedTest</code> class will try to clean folder from previous runs upon getting disposed.</p>
</li>
</ul>
</article>
          </div>
          
          <div class="hidden-sm col-md-2" role="complementary">
            <div class="sideaffix">
              <div class="contribution">
                <ul class="nav">
                  <li>
                    <a href="https://github.com/catalyst-network/catalyst.node/blob/merge/Integration-tests-in-Catalyst.Node.md/#L1" class="contribution-link">Improve this Doc</a>
                  </li>
                </ul>
              </div>
              <nav class="bs-docs-sidebar hidden-print hidden-xs hidden-sm affix" id="affix">
              <!-- <p><a class="back-to-top" href="#top">Back to top</a><p> -->
              </nav>
            </div>
          </div>
        </div>
      </div>
      
      <footer>
        <div class="grad-bottom"></div>
        <div class="footer">
          <div class="container">
            <span class="pull-right">
              <a href="#top">Back to top</a>
            </span>
            <span>Copyright © 2019 <a href='https://catalystnet.org'>Catalyst Network</a>
            
          </span></div>
        </div>
      </footer>
    </div>
    
    <script type="text/javascript" src="../styles/docfx.vendor.js"></script>
    <script type="text/javascript" src="../styles/docfx.js"></script>
    <script type="text/javascript" src="../styles/main.js"></script>
  </body>
</html>
